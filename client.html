<!-- Version: asdv (accelerometer, socket, DoryNode, view) -->

<html>
  <head>
  </head>
  <body>
    <h1>client.html</h1>
    <label>x: </label>
    <input type="text" id="x" size="5" readonly="readonly">
    <br/>
    <label>y: </label>
    <input type="text" id="y" size="5" readonly="readonly">
    <br/>
    <label>z: </label>
    <input type="text" id="z" size="5" readonly="readonly">
    <br/>
    <label>Time: </label>
    <input type="text" id="time" size="12" readonly="readonly">

    <p>
      <canvas id="canvasXY" width="300" height="300" style="border: solid;"></canvas>
      <canvas id="canvasZ" width="20" height="300" style="border: solid;"></canvas>
    </p>

    <script>
      const wsUrl = 'ws://192.168.1.26:8080'        // Update this to the network IP on which the server is running. DoryNode can tell you.
      const xEl = document.getElementById('x')
      const yEl = document.getElementById('y')
      const zEl = document.getElementById('z')
      const timeEl = document.getElementById('time')
      const canvasXY = document.getElementById('canvasXY')
      const contextXY = canvasXY.getContext('2d')
      contextXY.fillStyle = 'rgb(0, 0, 255)'
      const canvasZ = document.getElementById('canvasZ')
      const contextZ = canvasZ.getContext('2d')
      contextZ.fillStyle = 'rgb(0, 0, 255)'

      let connection                                // our WebSocket object

      openConnection()

      function openConnection() {
        connection = new WebSocket(wsUrl)
        connection.onopen = onConnectionOpen
        connection.onmessage = onConnectionMessage
        connection.onclose = onConnectionClose
        connection.onerror = onConnectionError
      }

      function onConnectionOpen() {
        console.log('client.html: connection open')
      }

      function onConnectionMessage(e) {
        //console.log(`client.html: received socket message: ${e.data}`)
        let readingArray = JSON.parse(e.data)  // array of reading objects
        let lastReading = readingArray[readingArray.length - 1]   // we'll only display the most recent reading
        let x = lastReading.x
        let y = lastReading.y
        let z = lastReading.z
        let time = lastReading.time

        xEl.value = x
        yEl.value = y
        zEl.value = z
        timeEl.value = time

        contextXY.clearRect(0, 0, canvasXY.width, canvasXY.height)
        contextZ.clearRect(0, 0, canvasZ.width, canvasZ.height)

        let length = x * 10
        contextXY.fillRect(150, 140, length, 20)

        length = y * -10
        contextXY.fillRect(140, 150, 20, length)

        length = (z - 9.8) * -10
        contextZ.fillRect(0, 150, 20, length)
      }

      function onConnectionClose() {
        console.error(`client.html: connection closed: check server is running at ${wsUrl}`)
      }

      function onConnectionError() {
        console.error(`client.html: connection error: check server is running at ${wsUrl}`)
      }

      setInterval(() => {   // periodically try to reopen the connection if need be
        if (connection.readyState === WebSocket.CLOSED) {
          console.error(`client.html: connection is closed: check server is running at ${wsUrl}`)
          console.log(`client.html: attempting to reopen connection`)
          openConnection()
        }
      }, 1000)

    </script>
  </body>
</html>